# OpenWrt IPv6 设置完全指南

## 前言

本方案旨在帮助您在 **OpenWrt 主路由拨号环境**下，优雅地配置和使用 IPv6 功能。

> **致伸手党和旁路由用户**
> *   **不提供任何旁路由（旁挂网关）的设置方案。** 强烈建议使用主路由，[原因请见此](https://web.archive.org/web/20250410000101/https://github.com/Aethersailor/Custom_OpenClash_Rules/wiki/关于旁路由的一些吐槽)。
> *   本文不涉及二级路由，请自行搜索相关教程。
> *   提问前请先完整阅读文档，确保您的问题未在文中解答。

---

## 快速指引：检查您的网络环境

在开始之前，请先确定您的宽带环境。这将决定您需要遵循哪种配置方案。

1.  **确认光猫工作模式**：
    *   **桥接模式 (Bridge Mode)**：光猫仅负责光电转换，由路由器进行 PPPoE 拨号。**这是推荐的工作模式。**
    *   **路由模式 (Route Mode)**：光猫负责拨号和路由，路由器作为二级路由。此模式可能导致 IPv6-PD 分配问题，建议修改为桥接模式。

2.  **确认 IPv6-PD (前缀委派) 是否可用**：
    *   **有 IPv6-PD**：您的运营商分配了地址块 (通常是 `/56` 或 `/60`)，允许您的路由器为局域网设备分配公网 IPv6 地址。**这是最理想的情况。**
    *   **无 IPv6-PD**：您的运营商只为路由器 WAN 口分配了一个 `/64` 地址，无法向下委派。这在某些校园网或特殊网络环境中常见。

**根据您的判断，选择对应的方案：**

*   **【方案一：IPv6-PD (推荐)】** 如果您能获取 IPv6-PD，请继续阅读本文后续章节。
*   **【方案二：IPv6 中继】** 如果您无法获取 IPv6-PD，但 WAN 口有 `/64` 地址，请直接跳转至 👉 **[IPv6 中继方案](./ipv6中继.md)**。

---

## 方案一：IPv6-PD 设置 (推荐)

本方案适用于绝大多数家庭宽带环境 (联通、电信、移动)。

### 第 1 步：WAN 接口设置

**目标**：让路由器通过拨号获取 IPv6 地址和 IPv6-PD 前缀。

我们提供“自动”和“手动”两种方式，**推荐使用“自动”方式**，除非您有特殊需求。

#### 自动创建 (推荐)

1.  **删除旧的 WAN6 接口** (如果有)。
2.  进入 `网络 > 接口 > WAN`，点击“修改”。
3.  在 **高级设置** 中，进行如下配置：
    *   **获取 IPv6 地址**: 设置为 `自动`。
    *   **使用内置的 IPv6 管理**: `勾选`。
    *   **使用从对端通告的 DNS 服务器**: `勾选`。
    *   **委托 IPv6 前缀**: `勾选`。
    *   **IPv6 分配长度**: `禁用`。
    *   **IPv6 首选项**: `留空`。
    ![WAN 口高级设置](/pics/v6-1.png)
    ![WAN 口高级设置](/pics/v6-2.png)
4.  切换到 **DHCP 服务器 > IPv6 设置**，确保此处的服务全部`禁用`。
    ![WAN 接口 DHCP IPv6 设置](/pics/v6-3.png)
5.  保存并应用。

完成后，在接口主页，您应该能看到一个名为 `wan_6` 的虚拟接口，并成功获取了 **IPv6 地址** 和 **IPv6-PD 前缀**。
![WAN 口 IPv6-PD 地址确认](/pics/wan.png)

> **如果未获取到 IPv6-PD 地址**：
> 1.  **检查光猫**：确认光猫已改为桥接模式，并开启了 IPv4/IPv6 双栈。
> 2.  **联系运维**: 直接联系光猫上的安装维护人员，确认宽带套餐支持 IPv6-PD。比打 100XX 客服电话更有效。

#### 手动创建 (备用)

如果您不希望自动创建 `wan_6` 接口，可以手动配置：

1.  确保 WAN 口高级设置中的 IPv6 相关选项已`禁用`。
2.  在 `网络 > 接口` 页面，新建一个接口，命名为 `WAN6`。
3.  **协议**: `DHCPv6 客户端`。
4.  **请求指定长度的 IPv6 前缀**: `自动`。
5.  **基本设置** 和 **高级设置** 参照下图配置：
    ![WAN6 接口配置 1](/pics/wan6-1.png)
    ![WAN6 接口配置 2](/pics/wan6-2.png)
6.  保存并应用。

### 第 2 步：LAN 接口设置

**目标**：让局域网内的设备获取公网 IPv6 地址，并能正常上网。

进入 `网络 > 接口 > LAN`，点击“修改”。

1.  在 **DHCP 服务器 > 常规设置** 中，确保 `忽略此接口` **未勾选**。
2.  切换到 **DHCP 服务器 > IPv6 设置**，这是配置的重点。
    *   **路由通告服务 (RA)**: `服务器模式`。
    *   **DHCPv6 服务**: `已禁用`。
    *   **NDP 代理**: `已禁用`。
    *   **通告的 DNS 服务器**: `留空`。
    ![LAN 口 DHCP 服务器 IPv6 设置 1](/pics/v6-5.png)
    ![LAN 口 DHCP 服务器 IPv6 设置 2](/pics/v6-6.png)
3.  切换到 **RA 设置**。
    *   **默认路由器**: `强制`。
    *   **通告的 DNS 服务器**: `留空`。
    *   **抑制默认的路由通告**: `不勾选`。
    *   **其他配置**: `不勾选`。

### 第 3 步：DNS 设置 (重要)

**核心原则：让所有设备使用路由器的 IPv4 地址作为唯一 DNS 服务器，即可同时解析 IPv4 和 IPv6 域名，这是最稳定、兼容性最好的方案。**

1.  **全局 DNS 设置**
    *   进入 `网络 > DHCP/DNS`。
    *   在 **高级设置** 中，**取消勾选** `禁止解析 IPv6 DNS 记录`。这是为了让 Dnsmasq 自身能处理 AAAA 记录。
    ![Dnsmasq IPv6 AAAA 记录过滤设置](/pics/v6-7.png)

2.  **LAN 口 DNS 通告设置**
    *   我们已经在 **第 2 步** 的 LAN 口配置中，将 IPv6 相关的 DNS 推送全部`禁用`了。这会强制所有客户端设备只获取到路由器的 IPv4 地址 (如 `192.168.1.1`) 作为 DNS 服务器。
    *   **为什么这样做？**
        *   **避免复杂性**：无需折腾 IPv6 DNS，减少出错可能。
        *   **提高兼容性**：部分设备 (尤其是 Windows) 在同时获取 IPv4 和 IPv6 DNS 时可能出现解析混乱或延迟。
        *   **工作原理**：DNS 查询本身是应用层协议，无论通过 IPv4 还是 IPv6 发起，只要 DNS 服务器 (Dnsmasq) 支持，就能返回 AAAA (IPv6) 记录。
        ![OpenWrt IPv4 地址作为 DNS](/pics/nslookup.png)

### 第 4 步：IPv6 后缀与固定地址 (可选)

默认情况下，设备会使用 SLAAC (无状态地址自动配置) 生成一个随机的 IPv6 地址后缀，这可能导致地址频繁变化。为了获得一个固定的、可预测的 IPv6 地址，推荐使用 EUI-64 后缀。

1.  进入 `网络 > 接口 > LAN`，点击“修改”。
2.  在 **高级设置** 中，找到 `IPv6 后缀`，填入 `eui64`。
    ![LAN 口 IPv6 后缀设置](/pics/eui64.png)
3.  保存并应用。

这会使设备的 IPv6 地址后缀根据其 MAC 地址生成，从而保持固定。更多技术细节请参考 [关于eui64的一些说明.md](./关于eui64的一些说明.md)。

### 第 5 步：测试 IPv6 连通性

1.  **关闭浏览器安全 DNS (DoH)**，否则会绕过你的路由器 DNS。
2.  使用 `Edge` / `Chrome` 等浏览器访问 [https://testipv6.cn/](https://testipv6.cn/)。
3.  如果一切正常，您应该会看到“全部通过”的结果。
    ![IPv6 测试结果](/pics/ipv6test.png)

> **注意**：不推荐使用 Firefox 进行测试，因为它默认启用 DoH 且 IPv4 优先。

---

## 防火墙与端口开放

**核心概念：IPv6 没有 NAT，设备获取的是公网地址。因此，不存在“端口转发”，只有“防火墙放行”。**

默认情况下，出于安全考虑，OpenWrt 的防火墙会阻止所有从公网到局域网设备的入站连接 (ICMPv6 除外)。

如果您需要从外部访问局域网内的某个设备 (如 NAS、服务器)，您需要手动创建防火墙规则。

1.  进入 `网络 > 防火墙 > 通信规则`。
2.  新建一条规则：
    *   **源区域**: `wan`
    *   **目标区域**: `lan`
    *   **目标地址**: 填写设备的 IPv6 地址的**后缀**部分 (例如 `::xxxx:xxxx:xxxx:xxxx`)。只填写后缀可以避免因运营商前缀变动导致规则失效。
    *   **目标端口**: 填写您需要开放的端口 (如 `5000`)。
    *   **操作**: `接受`。

具体设置可参考：[ImmortalWrt FAQ - IPv6 如何正确配置端口转发？](https://web.archive.org/web/20250410000101/https://github.com/immortalwrt/user-FAQ/blob/main/immortalwrt%20常见问题指北.md#6-ipv6如何正确配置端口转发)

---

## Lean's Lede 固件设置参考

Lede 的设置界面有所不同，但原理相通。以下为关键配置项，请自行对照。

*   **WAN 口**:
    *   高级设置 > `使用内置的 IPv6 管理`
    *   高级设置 > `使用从对端通告的 DNS 服务器`
    *   高级设置 > `禁用 IPv6 分配长度`
    *   高级设置 > `委托 IPv6 前缀`
*   **LAN 口**:
    *   DHCP 服务器 > IPv6 设置 > `路由通告服务`: `服务器模式`
    *   DHCP 服务器 > IPv6 设置 > `DHCPv6 服务`: `服务器模式`
    *   DHCP 服务器 > IPv6 设置 > `NDP 代理`: `已禁用`
*   **Dnsmasq**:
    *   网络 > Dnsmasq > `禁止解析 IPv6 DNS 记录`: `不勾选`

---

## 常见问题 (FAQ)

1.  **为什么我的设备无法获取 IPv6 地址？**
    *   **光猫模式**：确认是桥接模式且开启了 IPv4/IPv6 双栈。
    *   **运营商支持**：确认宽带套餐支持 IPv6-PD。
    *   **OpenWrt 设置**：仔细核对本文中的 WAN 和 LAN 口设置。
    *   **重启大法**：重启路由器和客户端设备。

2.  **为什么 IPv6 速度很慢或不稳定？**
    *   **DNS 问题**：检查是否遵循了本文的 DNS 设置建议，避免使用 IPv6 DNS。
    *   **硬件性能**：老旧路由器可能无法高效处理 IPv6 流量。
    *   **运营商网络**：有时运营商的 IPv6 网络质量本身可能存在波动。

3.  **如何通过命令行测试？**
    *   `ping -6 ipv6.google.com` (Windows) 或 `ping6 ipv6.google.com` (Linux/macOS)
    *   `nslookup -q=AAAA ipv6.google.com`
